version: 2.1

jobs:
  build-and-deploy-gh-pages:
    machine:
      image: ubuntu-2204:current
    resource_class: medium
    working_directory: ~/project
    steps:
      - checkout

      - run:
          name: Skip CI?
          command: |
            msg="$(git log -1 --pretty=%B)"
            if [[ "$msg" == *"[skip-ci]"* ]]; then
              circleci step halt
            fi

      - run:
          name: Install dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y git rsync

      - restore_cache:
          keys:
            - v2-rubydeps-{{ checksum "Gemfile.lock" }}
            - v2-rubydeps-

      - run:
          name: "Build site via docker-compose (service: web)"
          command: |
            set -euo pipefail

            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            else
              sudo apt-get install -y docker-compose
              COMPOSE="docker-compose"
            fi

            UIDGID="$(id -u):$(id -g)"
            ENV_VARS=(-e HOME=/project -e GEM_HOME=/project/vendor/gems -e GEM_PATH=/project/vendor/gems)

            rm -rf vendor/bundle vendor/gems _site .bundle
            mkdir -p vendor/bundle vendor/gems

            $COMPOSE build web

            $COMPOSE run --rm --no-deps --user "$UIDGID" "${ENV_VARS[@]}" web gem install bundler -v 2.5.6 --no-document
            $COMPOSE run --rm --no-deps --user "$UIDGID" "${ENV_VARS[@]}" web bundle _2.5.6_ config set --local path "vendor/bundle"
            $COMPOSE run --rm --no-deps --user "$UIDGID" "${ENV_VARS[@]}" web bundle _2.5.6_ config set --local deployment "true"
            $COMPOSE run --rm --no-deps --user "$UIDGID" "${ENV_VARS[@]}" web bundle _2.5.6_ install --jobs 4 --retry 3

            $COMPOSE run --rm --no-deps --user "$UIDGID" "${ENV_VARS[@]}" web bundle _2.5.6_ exec jekyll clean
            $COMPOSE run --rm --no-deps --user "$UIDGID" "${ENV_VARS[@]}" web bundle _2.5.6_ exec jekyll build --baseurl "/koru-jekyll-template"

            test -d _site
            test -f _site/index.html

      - save_cache:
          key: v2-rubydeps-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
            - vendor/gems

      - run:
          name: Publish _site to gh-pages
          command: |
            set -euo pipefail

            test -d _site
            test -f _site/index.html

            DEPLOY_DIR="/tmp/gh-pages-deploy"
            rm -rf "$DEPLOY_DIR"
            mkdir -p "$DEPLOY_DIR"

            rsync -a --delete _site/ "$DEPLOY_DIR"/
            touch "$DEPLOY_DIR/.nojekyll"

            cd "$DEPLOY_DIR"
            git init
            git config user.email "${GITHUB_USER_EMAIL}"
            git config user.name "${GITHUB_USER_NAME}"
            git add -A
            git commit -m "Deploy to GitHub Pages [skip-ci]"

            git branch -M gh-pages
            git remote add origin "https://x-access-token:${GITHUB_ACCESS_TOKEN}@github.com/NCAR/koru-jekyll-template.git"
            git push -f origin gh-pages

workflows:
  deploy:
    jobs:
      - build-and-deploy-gh-pages:
          context: web-modernization
          filters:
            branches:
              only: master
