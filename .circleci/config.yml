version: 2.1

jobs:
  build-and-deploy-gh-pages:
    machine:
      image: ubuntu-2204:current
    resource_class: medium
    working_directory: ~/project
    steps:
      - checkout

      - run:
          name: Skip CI?
          command: |
            msg="$(git log -1 --pretty=%B)"
            if [[ "$msg" == *"[skip-ci]"* ]]; then
              circleci step halt
            fi

      - run:
          name: Install dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y git rsync

      - restore_cache:
          keys:
            - v1-bundle-{{ checksum "Gemfile.lock" }}
            - v1-bundle-

      - run:
          name: "Build site via docker-compose (service: web)"
          command: |
            set -euo pipefail

            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            else
              sudo apt-get install -y docker-compose
              COMPOSE="docker-compose"
            fi

            UIDGID="$(id -u):$(id -g)"

            $COMPOSE build web

            rm -rf vendor/bundle _site
            mkdir -p vendor/bundle

            $COMPOSE run --rm --no-deps --user "$UIDGID" web bundle config set --local path "vendor/bundle"
            $COMPOSE run --rm --no-deps --user "$UIDGID" web bundle config set --local deployment "true"
            $COMPOSE run --rm --no-deps --user "$UIDGID" web bundle _2.5.6_ install --jobs 4 --retry 3

            $COMPOSE run --rm --no-deps --user "$UIDGID" web bundle _2.5.6_ exec jekyll clean
            $COMPOSE run --rm --no-deps --user "$UIDGID" web bundle _2.5.6_ exec jekyll build --baseurl "/koru-jekyll-template"

            test -d _site
            test -f _site/index.html

      - save_cache:
          key: v1-bundle-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

      - run:
          name: Configure git + authenticated origin
          command: |
            set -euo pipefail
            git config --global user.email "${GITHUB_USER_EMAIL}"
            git config --global user.name "${GITHUB_USER_NAME}"
            git remote set-url origin "https://x-access-token:${GITHUB_ACCESS_TOKEN}@github.com/NCAR/koru-jekyll-template.git"

      - run:
          name: Publish _site to gh-pages
          command: |
            set -euo pipefail

            git fetch origin gh-pages || true

            rm -rf .worktree-gh-pages
            mkdir -p .worktree-gh-pages

            if git show-ref --verify
